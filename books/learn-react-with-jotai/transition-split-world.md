---
title: "トランジションと“世界の分岐”"
---

トランジションは、よく考えると不思議な挙動を示します。前章の例で考えましょう。ボタンを押してサスペンドしたということは、Reactは間違いなく`userId`が`"user2"`であるUIをレンダリングしたはず（サスペンドにより中断されましたが）です。しかし、それとは別に`userId`が`"user1"`であり、かつ`isPending`が`true`に変わった状況のUIもレンダリングしています。

これは、Reactが **「2つの異なる世界のUIを同時にレンダリングしている」** と考えると理解しやすいです。1つ目の世界は、`userId`が`"user2"`である新しい世界です。この世界ではサスペンドが発生しているため、画面にまだ反映されていません。2つ目の世界は、`userId`が`"user1"`である古い世界です。サスペンドの待機中はこの古い世界がまだ画面に残っており、何なら`isPending`が変化するなど未だメンテナンスされています。

この“世界の分岐”の細かな挙動については、筆者が以前別の本にまとめていますので、詳しくはそちらをご覧ください。

https://zenn.dev/uhyo/books/react-concurrent-handson-2

## トランジションと「更新の優先度」

前章で、トランジションは「優先度が低い更新」として扱われると説明しました。どうしてそれが、サスペンド中は古いUIが表示されるという挙動になるのでしょうか。考えてみましょう。

まず、Reactの責務は、UIライブラリとして、プログラムで指示されたとおりにUIを描画することです。そうなると、ステートが更新されたのであれば、そのステートに基づいた新しいUIを最速で描画し、画面に反映しなければなりません。これが、Suspense以前、そしてトランジションを使う前にこれまで見てきた挙動です。

トランジションを使わずに`userId`が`"user1"`から`"user2"`に変わったのであれば、Reactはすぐに`userId`が`"user2"`であるUIを描画しようとします。言い換えれば、これが「優先度の高い更新」であるため、Reactは何としても`"user2"`の画面を描画しなければならず、`"user1"`の画面を消さなければなりません。

しかし、`"user2"`の画面をレンダリングしたらサスペンドが発生してしまいます。そのため、サスペンドにより表示できない部分はフォールバックUIを表示します。

フォールバックにはなってしまいましたが、Reactは`"user1"`の表示を画面から撤去し、`"user2"`というステートに基づくUIを画面に表示しました。しっかりとReactの責務を果たしています。

では、トランジションを使った場合はどうでしょうか。`userId`が`"user2"`に変わったので、Reactはやはり`"user2"`のUIを描画しようとします。しかし、今回は「優先度の低い更新」であるため、Reactは**無理に`"user2"`のUIを描画しようとしなくても良い**のです。

Reactは、サスペンドが発生しまだ`"user2"`のUIを完全な形で描画できないことを検知します。優先度が低い更新であるため、Reactは中途半端な状態（フォールバックUI）で`"user2"`のUIを表示するのを避け、`"user1"`のUIを画面に残し続けることを選択したのです。

このように、更新の優先度が低い場合、Reactは素早く新しいステートを画面に表示するよりも、**完全なUIができあがるまで待つ**ことを選択します。これがトランジションと更新の優先度の関係です。

### トランジションのレンダリングの順番

先ほど説明したように、トランジション発生時にはReactは2つの世界のUIを同時にレンダリングしています。「`isPending`が`true`になった古い世界」と、「`userId`が新しい値に変わった新しい世界」です。この2つは、どちらが先にレンダリングされるのでしょうか？

答えは、「`isPending`が`true`になった古い世界」が先にレンダリングされ、その後に「`userId`が新しい値に変わった新しい世界」がレンダリングされます。

この理由もやはり、トランジションが「優先度の低い更新」であることに関係しています。優先度が低いから後回しでもいいのです。一方、`isPending`が`true`になる更新は、ユーザーに素早くフィードバックを返すためにも最速で行う必要があります。したがって、`isPending`の更新が先にレンダリングされ、その後にトランジションの更新がレンダリングされるわけです。

「新しい世界」のレンダリングが後回しになって結果的に若干遅れていますが、トランジションは優先度が低い更新なので問題ありません。

ちなみに、「新しい世界」のレンダリングの最中にユーザーが「古い世界」で追加の操作を行った場合には、そちらの処理が優先されて「新しい世界」のレンダリングはさらに後回しにされます。Reactは高度なジョブスケジューリング機構を持っており、優先度の概念はその中でも活用されています。

## ペンディング状態が一瞬表示される問題

ところで、前章のトランジションを動かすと、確かにフォールバックUIが表示されることはなくなりましたが、**また別の問題**が起きていることにお気づきでしょうか。

最初にユーザー1が選択されていて、「ユーザー2を選択」を押したときの動きはまったく問題ありません。プロフィール表示が「ユーザー1さんのプロフィール」のまま維持され、その下に「(読み込み中...)」が表示されます。しばらくすると、プロフィール表示が「ユーザー2さんのプロフィール」に切り替わります。

では、「ユーザー2を選択」ボタンを押してユーザー2のプロフィールが表示されたあと、もう一度「ユーザー1を選択」ボタンを押した場合どうなるでしょうか？　この場合、`user1`のデータはキャッシュが効いているため、待たずに取得できます。そのため、古いUIを維持する必要がなく、すぐに`user1`のプロフィールが表示されることが期待されます。

実際にやってみると、確かにすぐに`user1`のプロフィールが表示されます。ただ、その前に一瞬だけ「(読み込み中...)」が表示されるのが見えるはずです。これが問題です。

「（読み込み中...）」は`isPending`がtrueのとき（ペンディング状態）の表示です。これが一瞬表示される理由は、先ほど説明したとおりですね。

そう、トランジション発生時、Reactはまず`isPending`がtrueの古い世界をレンダリングします。これが最速で画面に反映されるので、「(読み込み中...)」が画面に出ます。その後、Reactは新しい世界のレンダリングを行います。今回はキャッシュが効いているためすぐにレンダリングが完了し、新しいUIが画面に反映されます。

その結果として、「(読み込み中...)」が一瞬だけ表示されてしまうのです。

こうなる理由は理解できましたが、何だか本末転倒に思われるかもしれません。フォールバックUIが一瞬表示される問題を回避するためにトランジションを使ったのに、今度はペンディング状態が一瞬表示される問題が発生してしまいました。

しかし、対処法はあります。フォールバックUIが一瞬表示される問題の解決にはReact側の助け（トランジション）が必要でしたが、ペンディング状態が一瞬表示される問題はこちら側で対処可能です。

### 対処法

対処法としては、とにもかくにも**トランジション中に表示するUIを工夫する**ことです。

基本的には、CSSでアニメーションさせるとよいでしょう。「（読み込み中...）」の文字列がフェードイン・フェードアウトするようにすれば、一瞬だけDOMに現れても気にならなくなります。

他にも、例えば`isPending`時に半透明になるUIであれば、CSSで透明度をアニメーションさせれば一瞬だけ`isPending`がtrueになっても気にならないでしょう。簡単な具体例としては、こうです。

```tsx
const UserProfile: React.FC<{ userId: string; isPending: boolean }> = ({ userId, isPending }) => {
  const user: User = useAtomValue(userAtomFamily(userId));

  return (
    <section>
      <h1>{user.name}さんのプロフィール</h1>
      <p aria-hidden={!isPending} style={{
        opacity: isPending ? 1 : 0,
        transition: 'opacity 0.3s ease',
      }}>(読み込み中...)</p>
      ...
    </section>
  );
};
```

あるいは、本題から外れるので説明は省略しますが、CSSの`@starting-style`を活用する方法もあります。

CSS以外の方法としては、タイマーなどを利用して`isPending`がtrueになってから時間差でペンディングUIを表示することも考えられます。ちょっと大がかりになってしまいますが。

筆者としても、このような工夫が必須になっているのはいかがなものかと思い、React側でいい感じに改善してくれないかとは思っているのですが、現状ではこのように対処するしかないようです。

## まとめ

この章では、トランジション発生時に「古い世界」と「新しい世界」の2つのUIが同時にレンダリングされることを解説しました。また、その帰結として、トランジション中にペンディング状態が一瞬表示される問題とその対処法についても説明しました。